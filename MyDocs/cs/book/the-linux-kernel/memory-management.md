#### 虚拟内存

- 更多地址空间
- 每个进程有自己的虚拟地址空间，各自独立
- 内存映射
- 物理内存平均(fair)分配  
- 可共享
- 无需顺序



虚拟内存和物理内存的对应关系，通过操作系统存储  

为了方便索引，内存需要被切分为合适的大小。这个大小的内存，被称为“页”。“页”的存储结构，叫做“页表”

而每个进程的都不同，但是因为会有交互的问题。所以页表都有几个标志：是否可用(valid)，对应的物理内存页，可访问信息（写、执行）。  



page fault  



demand paging ：按需加载页

swapping:  物理内存不足时，擦除备份。此操作过多会引起“页抖动”(thrashing)

共享虚拟内存：

物理 还是 虚拟寻址模式：操作系统本身没必要维护自己的虚拟地址、linux kernel 是物理寻址、

访问控制：



内核空间、用户空间的理解：

首先理解了上面的虚拟地址。

再加上需要对用户进行权限划分，那么实际上是对用户的地址空间进行了限制，同样的有专门的内核地址空间。当访问对应的地址时，即认为切换

同样由于空间模式的切换，页信息上需要标注内核、用户是否能读写页的标记。  



#### 缓存

- buffer :

  所有的硬件都叫做“block” 设备。因为它们在读写时能访问的数据是固定大小的区块。也因此缓存是固定大小的，在这叫做buffer

- page

  从磁盘加载到内存时，总是要经过“页”化，就在加载时一次缓存一页

- swap

  修改过的页会被存储为swap 文件。

- hardware

  处理器自带；Page Table Entries 的缓存。



#### Linux页表

有三级页表（目前理解成为了存储足够的地址



#### 页分配和回收

物理页在系统中的数据结构是 ：`mem_map`，是`mem_map_t` 列表，主要字段：

- count : 页所属用户数
- age：用于作为擦除或者swap 的依据
- map_nr：物理页帧数



伙伴算法  



#### 内存映射

进程虚拟内存的数据结构：`mm_struct`  

包含部分加载的`vm_area_struct`  



#### Demand Paging

AVL (Adelson-Velskii and Landis) tree structure.



#### Swap（置换）

**Swap out 和擦除page**

> 这里都是在讲物理内存页

kernel swap daemon(kswapd) ，一种特殊类型的进程，kernel 线程  

kernel 线程是没有虚拟内存的进程。以kernel 模式运行在物理地址空间

kswapd 名字是一个泛称，功能并不仅限于将page 置换到swap 文件，更要保持一定的空闲页来保证系统内存管理的效率



使用`free_pages_high` 和`free_pages_low` 来标记是否物理地址空间过少。当较少时，通过`nr_async_pages` 记录要被写入swap 文件的页数（添加到队列中时+1，写完时-1）  

当空余物理内存页较少时，kswapd 会做出以下调整：

- 首先，减少buffer 缓存/页缓存的大小
  
  被page 缓存持有的，或者buffer 缓存中的页是比较好的调整对象。它们不需要进行物理写  
  
  影响访问物理设备的速度，以及内存映射文件的速度。同时所有相关的进程都会受到影响
  
  clock 算法。每次检查`mem_map` 中的一个页块（少数页数）
  
- 如果不足，然后，置换System V 共享内存页

  System V 共享内存 算是一种IPC 交互机制。

  而这里只讲System V 共享内存，以`shmid_ds` 数据结构描述每块内存区域。包含`vm_area_struct` 列表指针，其中一个用于每个进程共享虚拟内存。

  然后是一系列置换策略

- 接着，置换和擦除进程独立的页

  不会置换镜像的执行指令，因为其不会变化。

  对象不包括共享和锁住的。

  linux 只置换被选择进程的一部分页

  置换算法主要基于 年龄。`swap_control` 。所有符合的页面，会首先根据`vm_ops` 进行置换操作，如果未指定操作，则由swapd 置换其为swap 文件并写入硬件。  

  然后是策略，对一个进程蚕食一次之后，下次请求会蚕食下一个进程。

**swap 缓存**

swap 文件在非必要的情况下，依旧不会被写入物理内存。  

即可理解成，依旧有一块内存区域作为 swap 文件的缓存区域。  

然后是一些缓存处理策略。

**从swap 到内存**

一些步骤





